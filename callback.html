<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Callback Zoho</title>
</head>
<body>
  <h2>Zoho OAuth - Callback</h2>
  <pre id="result">Procesando...</pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    const clientId = "1000.91OKIP58EORRMDO1N15E9ZY1MZ6LTO";
    const clientSecret = "a323bc477e46b206971cc708bb1a44a0fe21623d9e";
    const redirectUri = "https://gabrielsolera.github.io/shopping_cart/callback.html";

    if (code) {
      const data = new URLSearchParams();
      data.append("grant_type", "authorization_code");
      data.append("client_id", clientId);
      data.append("client_secret", clientSecret);
      data.append("redirect_uri", redirectUri);
      data.append("code", code);

      fetch("https://accounts.zoho.com/oauth/v2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: data.toString()
      })
      .then(res => res.json())
      .then(tokenData => {
        localStorage.setItem("zoho_access_token", tokenData.access_token);
        localStorage.setItem("zoho_refresh_token", tokenData.refresh_token);
        localStorage.setItem("zoho_token_expiry", Date.now() + tokenData.expires_in * 1000); // en ms
        document.getElementById("result").textContent = "Token obtenido, redirigiendo...";
        setTimeout(() => window.location.href = "dashboard.html", 1000);
      })
      .catch(err => {
        document.getElementById("result").textContent = "Error al obtener token: " + err;
      });
    } else {
      document.getElementById("result").textContent = "No se recibió ningún código de autorización.";
    }
  </script>
</body>
</html>
