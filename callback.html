<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zoho OAuth - Callback</title>
</head>
<body>
  <h2>Zoho OAuth - Callback</h2>
  <pre id="result">Procesando...</pre>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (!code) {
      document.getElementById("result").textContent = "❌ No se recibió ningún código de autorización.";
    } else {
      const scriptUrl = "https://script.google.com/macros/s/AKfycbwg46teFrUvY1r5ENqqRSeGtkRqJsDnASxTUGJQRbAUYQJ0yZ6jJ0zYoob6gn2VY_PEsA/exec";
      const callbackUrl = `${scriptUrl}?code=${code}`;

      fetch(callbackUrl)
        .then(res => res.text())
        .then(text => {
          document.getElementById("result").textContent = text;

          // Extraer tokens del texto de respuesta
          const accessMatch = text.match(/Access Token: ([\w\d\-_.]+)/);
          const refreshMatch = text.match(/Refresh Token: ([\w\d\-_.]+)/);

          if (accessMatch && refreshMatch) {
            const accessToken = accessMatch[1];
            const refreshToken = refreshMatch[1];
            const now = Date.now();

            localStorage.setItem("zoho_access_token", accessToken);
            localStorage.setItem("zoho_refresh_token", refreshToken);
            localStorage.setItem("zoho_token_expiry", now + 3600 * 1000); // 1h vencimiento estimado

            // Redirigir al dashboard (opcional)
            // window.location.href = "dashboard.html";
          }
        })
        .catch(err => {
          document.getElementById("result").textContent = "❌ Error al comunicarse con Apps Script: " + err;
        });
    }
  </script>
</body>
</html>
